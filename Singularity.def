Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

%files
    # Copy requirements and local libraries needed for installation
    requirements.txt /opt/origs_source/requirements.txt
    jax_requirements.txt /opt/origs_source/jax_requirements.txt
    lib_render /opt/origs_source/lib_render

%post
    # Set non-interactive installation
    export DEBIAN_FRONTEND=noninteractive

    # Install system utilities
    apt-get update && apt-get install -y \
        git \
        curl \
        wget \
        build-essential \
        libgl1-mesa-glx \
        libglib2.0-0 \
        vim \
        && rm -rf /var/lib/apt/lists/*

    # Install Miniconda
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/conda
    rm /tmp/miniconda.sh
    
    # Source conda to make it available in this shell
    . /opt/conda/etc/profile.d/conda.sh
        
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

    # Create the environment 'origs' matching install.sh
    # Includes specific gcc/gxx versions for compatibility
    conda create -n origs gcc_linux-64=9 gxx_linux-64=9 python=3.10 numpy=1.26.4 -y
    
    # Run the installation steps in bash to handle conda activation scripts correctly
    /bin/bash <<'EOF'
    set -e
    source /opt/conda/etc/profile.d/conda.sh
    conda activate origs
    
    # Set compiler environment variables to use the conda-installed compilers
    export CC=$CONDA_PREFIX/bin/x86_64-conda-linux-gnu-gcc
    export CXX=$CONDA_PREFIX/bin/x86_64-conda-linux-gnu-g++
    export CPP=$CONDA_PREFIX/bin/x86_64-conda-linux-gnu-g++

    echo "Verifying compilers:"
    $CC --version
    $CXX --version
    
    # --- Begin installation steps from install.sh ---
    
    pip install numpy==1.26.4
    
    # PyTorch and Core Libs
    # conda install pytorch==2.3.1 torchvision==0.18.1 torchaudio==2.3.1 pytorch-cuda=11.8 -c pytorch -c nvidia
    # pip install torch==2.1.0 torchvision==0.16.0 torchaudio==2.1.0 --index-url https://download.pytorch.org/whl/cu118
    conda install pytorch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1  pytorch-cuda=11.8 -c pytorch -c nvidia    
    conda install fvcore iopath -c fvcore -c iopath -c conda-forge -y
    conda install nvidiacub -c bottler -y
    conda install pytorch3d -c pytorch3d -y
    # pip install "git+https://github.com/facebookresearch/pytorch3d.git@stable" --no-build-isolation


    pip install pyg_lib torch_scatter torch_geometric torch_sparse torch_cluster torch_spline_conv -f https://data.pyg.org/whl/torch-2.4.1+cu118.html
    conda install xformers -c xformers -y
    
    # Install requirements from file
    cd /opt/origs_source
    pip install chumpy --no-build-isolation
    pip install -r requirements.txt
    pip install numpy==1.26.4
    
    # # pip uninstall torch torchvision torchaudio -y
    # # pip install torch==2.2.0 torchvision==0.17.0 torchaudio==2.2.0 --index-url https://download.pytorch.org/whl/cu118
    # # Install Gaussian Splatting Custom Rasterizers
    # # These require the compilers set above
    # pip install lib_render/simple-knn --no-build-isolation
    # pip install lib_render/diff-gaussian-rasterization-alphadep-add3 --no-build-isolation
    # pip install lib_render/diff-gaussian-rasterization-alphadep --no-build-isolation
    # pip install lib_render/gof-diff-gaussian-rasterization --no-build-isolation
    
    # # Final dependency updates
    # pip install numpy==1.26.4
    # pip install -U scikit-learn
    # pip install -U scipy
    # pip install opencv-python==4.10.0.84
    # pip install mmcv-full==1.7.2

    # # jax
    # pip install -r jax_requirements.txt

    
    # --- End installation steps ---
EOF
    
    # Clean up to reduce image size
    conda clean --all -y

%environment
    # Set up environment variables for the runtime
    export CONDA_DIR=/opt/conda
    # Prepend the origs environment bin to PATH so it is active by default
    export PATH=/opt/conda/envs/origs/bin:$PATH
    
    # Set compiler variables for runtime usage (if user compiles code inside container)
    export CC=/opt/conda/envs/origs/bin/x86_64-conda-linux-gnu-gcc
    export CXX=/opt/conda/envs/origs/bin/x86_64-conda-linux-gnu-g++
    export CPP=/opt/conda/envs/origs/bin/x86_64-conda-linux-gnu-g++
    
    # source /opt/conda/etc/profile.d/conda.sh
    # conda activate origs

%runscript
    # Default command when running the container
    exec /bin/bash "$@"

%help
    This container provides the 'origs' environment for OriGS.
    It includes:
    - CUDA 11.8
    - PyTorch 2.1.0
    - Python 3.10
    - Custom Gaussian Splatting Rasterizers
    
    The conda environment 'origs' is automatically added to PATH.
    
    Usage:
    singularity shell --nv origs.sif
    singularity run --nv origs.sif



# pip torch
# pip install "git+https://github.com/facebookresearch/pytorch3d.git@stable" --no-build-isolation


